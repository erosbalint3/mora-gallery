server {
    listen 80 default_server;
    return 301 https://gallery.mora.u-szeged.hu$request_uri; 
}

proxy_cache_path /var/run/nginx-cache levels=1:2 keys_zone=gallerycache:1m inactive=4800m;

server {
    proxy_cache gallerycache;

    error_log off;

    listen 443 ssl default_server;
    server_name gallery.mora.u-szeged.hu;

    root /srv/mora-gallery/public;

    client_max_body_size 5000m;
    
    ssl_certificate_key /etc/ssl/private/mora.u-szeged.hu.key;
    ssl_certificate /etc/ssl/certs/mora.u-szeged.hu.cer;

    location / {
        autoindex off;
    }
    
    location ^~ /error/ {
        internal;
        allow all;
        auth_basic off;
    }

    location ~*  \.(css|js)$ {
        expires 1d;
    }

    error_page 404 /error/404.html;

    add_header X-Frame-Options SAMEORIGIN;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    gzip on;
    gzip_types application/json;
    gzip_min_length 500;

    server_tokens off;
    add_header Cache-Control "public";


    fastcgi_buffer_size 64k;
    fastcgi_buffers 4 64k;
    fastcgi_buffering on;
    fastcgi_keep_conn on;
    set $photo_path "/media/mora_photo/nyilvanos";

    add_header X-GG-Cache-Status $upstream_cache_status;
    add_header X-Robots-Tag "noindex" always;   

    location = /yearlist {

	limit_except GET { deny  all; }
	root /srv/mora-gallery;
	fastcgi_pass  unix:/var/run/fcgiwrap.socket;

	fastcgi_param  PHOTO_PATH	$photo_path;
	fastcgi_param  SCRIPT_NAME        $fastcgi_script_name;
	fastcgi_param  REQUEST_URI        $request_uri;
	fastcgi_param  DOCUMENT_URI       $document_uri;
	fastcgi_param  DOCUMENT_ROOT      $document_root;

	fastcgi_param SCRIPT_FILENAME /srv/mora-gallery/cgi-bin/yearlist.pl;
    }

    location ~ ^\/albumlist\/([1-2][0-9][0-9][0-9])$ {
	limit_except GET { deny  all; }
	root /srv/mora-gallery;
	fastcgi_pass  unix:/var/run/fcgiwrap.socket;

	fastcgi_param  PHOTO_PATH	$photo_path;
	fastcgi_param  SCRIPT_NAME        $fastcgi_script_name;
	fastcgi_param  REQUEST_URI        $request_uri;
	fastcgi_param  DOCUMENT_URI       $document_uri;
	fastcgi_param  DOCUMENT_ROOT      $document_root;

	fastcgi_param year $1;

	fastcgi_param SCRIPT_FILENAME /srv/mora-gallery/cgi-bin/albumlist.pl;
    }

    location ~ ^\/thumbnail\/(jpeg|webp)\/([1-2][0-9][0-9][0-9]\/[a-zA-Z0-9_]*\/[a-zA-Z0-9_\-]*\.(jpg|png|jpeg|JPG))$ {
	limit_except GET { deny  all; }
	root /srv/mora-gallery;
	fastcgi_pass  unix:/var/run/fcgiwrap.socket;

	fastcgi_param  PHOTO_PATH	$photo_path;
	fastcgi_param  SCRIPT_NAME        $fastcgi_script_name;
	fastcgi_param  REQUEST_URI        $request_uri;
	fastcgi_param  DOCUMENT_URI       $document_uri;
	fastcgi_param  DOCUMENT_ROOT      $document_root;
	fastcgi_param	size	400;
	fastcgi_param	format  $1;
	fastcgi_param	photo	$2;

	fastcgi_param SCRIPT_FILENAME /srv/mora-gallery/cgi-bin/convert.pl;
        expires 7d;
    }

    location ~ ^\/watermark\/(jpeg|webp)\/([1-2][0-9][0-9][0-9]\/[a-zA-Z0-9_]*\/[a-zA-Z0-9_\-]*\.(jpg|png|jpeg|JPG))$ {
	limit_except GET { deny  all; }
	root /srv/mora-gallery;
	fastcgi_pass  unix:/var/run/fcgiwrap.socket;

	fastcgi_param  PHOTO_PATH	$photo_path;
	fastcgi_param  SCRIPT_NAME        $fastcgi_script_name;
	fastcgi_param  REQUEST_URI        $request_uri;
	fastcgi_param  DOCUMENT_URI       $document_uri;
	fastcgi_param  DOCUMENT_ROOT      $document_root;
	fastcgi_param	size	2048;
	fastcgi_param	photo	$2;
	fastcgi_param	format  $1;
	fastcgi_param	watermark	/srv/mora-gallery/watermark.png;

	fastcgi_param SCRIPT_FILENAME /srv/mora-gallery/cgi-bin/convert.pl;

        expires 7d;
	
	add_header Feature-Policy "web-share self;";
    }

    location ~ ^\/filelist\/([1-2][0-9][0-9][0-9])\/([a-zA-Z0-9_]*)$ {
	limit_except GET { deny  all; }
	root /srv/mora-gallery;
	fastcgi_pass  unix:/var/run/fcgiwrap.socket;

	fastcgi_param  PHOTO_PATH	$photo_path;
	fastcgi_param  SCRIPT_NAME        $fastcgi_script_name;
	fastcgi_param  REQUEST_URI        $request_uri;
	fastcgi_param  DOCUMENT_URI       $document_uri;
	fastcgi_param  DOCUMENT_ROOT      $document_root;
	fastcgi_param	year	$1;
	fastcgi_param	album	$2;
	fastcgi_param	size	2048;

	fastcgi_param REQUESTED_IMAGE $uri;
	fastcgi_param SCRIPT_FILENAME /srv/mora-gallery/cgi-bin/filelist.py;

        expires 30m;
    }

    location ~ ^\/video(\/[1-2][0-9][0-9][0-9]\/[a-zA-Z0-9_]*\/[a-zA-Z0-9_\-]*\.mp4)(\?.*)?$ {
        mp4;
        mp4_buffer_size       1m;
        mp4_max_buffer_size   5m;
        #mp4_limit_rate        on; TODO
        #mp4_limit_rate_after  30s;

        root $photo_path;
        try_files $1 =404;
    }

    location ~ ^\/videothumbnail\/(jpeg|webp)\/([1-2][0-9][0-9][0-9]\/[a-zA-Z0-9_]*\/[a-zA-Z0-9_\-]*\.mp4)$ {
        limit_except GET { deny  all; }
        root /srv/mora-gallery;
        fastcgi_pass  unix:/var/run/fcgiwrap.socket;

        fastcgi_param  VIDEO_PATH       $photo_path;
        fastcgi_param  SCRIPT_NAME        $fastcgi_script_name;
        fastcgi_param  REQUEST_URI        $request_uri;
        fastcgi_param  DOCUMENT_URI       $document_uri;
        fastcgi_param  DOCUMENT_ROOT      $document_root;
        fastcgi_param   size    400;
        fastcgi_param   format  $1;
        fastcgi_param   video   $2;

        fastcgi_param SCRIPT_FILENAME /srv/mora-gallery/cgi-bin/videothumb.py;

        expires 7d;
    }

}

